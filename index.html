<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sales-Core | å›°éš¾å´©å¡Œ PWA</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3182ce">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1162/1162460.png">

  <style>
    /* ç»§æ‰¿ v4.3 ç²¾é«“æ ·å¼ */
    :root {
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --accent-blue: #3182ce;
      --accent-orange: #dd6b20;
      --led-bg: #000000;
      --led-text: #f6ad55;
      --success-green: #38a169;
    }

    body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-gradient); margin: 0; padding: 0; min-height: 100vh; }

    /* LED æ»šåŠ¨æ¡ */
    .led-banner { background: var(--led-bg); color: var(--led-text); height: 44px; line-height: 44px; overflow: hidden; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .marquee-wrapper { display: flex; width: fit-content; animation: marquee 60s linear infinite; }
    .marquee-content { display: flex; white-space: nowrap; }
    .marquee-content span { padding: 0 40px; letter-spacing: 2px; text-shadow: 0 0 8px var(--led-text); font-weight: bold; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    .container { padding: 20px; box-sizing: border-box; }
    header { text-align: center; margin-bottom: 25px; }
    h1 { color: var(--accent-blue); font-size: 1.5rem; margin-bottom: 10px; }

    /* PWA å¼•å¯¼æ¨ªå¹… - å¢å¼ºç‰ˆ */
    #installBanner {
      display: none; /* é€»è¾‘æ§åˆ¶æ˜¾ç¤º */
      background: var(--accent-blue); color: white;
      padding: 0 20px;
      height: 50px;
      line-height: 50px;
      position: fixed; bottom: 20px; left: 20px; right: 20px;
      border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 9999; animation: slideUp 0.5s ease-out;
      display: flex; justify-content: space-between; align-items: center;
    }
    #installText { flex: 1; font-weight: bold; cursor: pointer; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #closeBanner { width: 30px; height: 30px; line-height: 30px; text-align: center; font-size: 20px; cursor: pointer; opacity: 0.8; }

    @keyframes slideUp { from { transform: translateY(100px); } to { transform: translateY(0); } }

    .main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; max-width: 1200px; margin: 0 auto; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }

    .slot { background: #fff; border: 1px solid #eee; border-left: 5px solid #cbd5e0; padding: 15px; border-radius: 8px; margin-bottom: 12px; transition: 0.3s; }
    .slot.filled { border-left-color: var(--success-green); background: #f0fff4; }

    input, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; background: #f8fafc; font-size: 1rem; margin-bottom: 10px; }
    textarea { height: 80px; resize: vertical; }

    .btn-export { background: var(--success-green); color: white; border: none; padding: 16px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }

    @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } .strategy-col { order: 2; } }
  </style>
</head>
<body>

<div id="installBanner">
  <div id="installText" onclick="triggerInstall()">ğŸš€ ç‚¹å‡»å®‰è£…â€œå†²é”‹å·â€åˆ°æ¡Œé¢</div>
  <div id="closeBanner" onclick="document.getElementById('installBanner').style.display='none'">Ã—</div>
</div>

<div class="led-banner">
  <div class="marquee-wrapper">
    <div class="marquee-content">
      <span>ğŸ”¥ å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯</span><span>ğŸš€ è·¯è™½è¿œï¼Œè¡Œåˆ™å°†è‡³ï¼›äº‹è™½éš¾ï¼Œåšåˆ™å¿…æˆ</span><span>âš¡ å¼ºè€…åªä¼šåˆ›é€ ç¯å¢ƒ</span><span>ğŸ† ä»Šå¤©çš„5ä¸ªè¿æ¥å†³å®šæ˜å¤©çš„æ”¶è·</span>
    </div>
    <div class="marquee-content">
      <span>ğŸ”¥ å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯</span><span>ğŸš€ è·¯è™½è¿œï¼Œè¡Œåˆ™å°†è‡³ï¼›äº‹è™½éš¾ï¼Œåšåˆ™å¿…æˆ</span><span>âš¡ å¼ºè€…åªä¼šåˆ›é€ ç¯å¢ƒ</span><span>ğŸ† ä»Šå¤©çš„5ä¸ªè¿æ¥å†³å®šæ˜å¤©çš„æ”¶è·</span>
    </div>
  </div>
</div>

<div class="container">
  <header>
    <h1>æ¯æ—¥é”€å”®-å›°éš¾ä»è¿™é‡Œå¼€å§‹å´©å</h1>
    <div id="dailyQuote" style="color:var(--accent-orange); font-weight:600;">é”€å”®æ˜¯æä¾›ä»·å€¼çš„æœºä¼š</div>
  </header>

  <div class="main-grid">
    <div class="card strategy-col">
      <h2>ğŸ›¡ï¸ æˆ˜ç•¥åº“</h2>
      <input type="text" id="theme" placeholder="ä»Šæ—¥è¿æ¥ä¸»é¢˜..." onchange="saveData()">
      <textarea id="script" placeholder="ç§¯æçš„è¯æœ¯é€»è¾‘..." onchange="saveData()"></textarea>
      <div style="font-size:0.8rem; color:#718096;">*æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼Œå³ä½¿æ–­ç½‘ä¹Ÿèƒ½ä½¿ç”¨</div>
    </div>

    <div class="card">
      <h2>âš”ï¸ å‰çº¿æˆ˜åœº</h2>
      <div id="slotsContainer"></div>
    </div>

    <div class="action-bar" style="grid-column: 1/-1;">
      <button class="btn-export" onclick="exportCSV()">ğŸ‰ å®Œæˆä»»åŠ¡å¹¶å¯¼å‡ºæˆ˜æŠ¥</button>
    </div>
  </div>
</div>

<script>
  // --- PWA æ ¸å¿ƒ ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').then(reg => console.log('PWA Ready'));
    });
  }

  let deferredPrompt;
  const banner = document.getElementById('installBanner');
  const installText = document.getElementById('installText');

  // 1. è‡ªåŠ¨æ•è·å®‰è£…äº‹ä»¶
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showBanner();
  });

  // 2. æ°¸ä¹…æ˜¾ç¤ºé€»è¾‘ï¼šå¦‚æœä¸æ˜¯ä»¥ App æ¨¡å¼æ‰“å¼€ï¼Œç›´æ¥å¼ºåˆ¶æ˜¾ç¤º
  function showBanner() {
    if (!isStandalone()) {
      banner.style.display = 'flex';
    }
  }

  // 3. iOS ç‰¹æ®Šå¼•å¯¼æ–‡å­—ä¿®æ”¹
  function applyIosPrompt() {
    if (isIos() && !isStandalone()) {
      installText.innerHTML = "ğŸ ç‚¹å‡»åº•éƒ¨â€œåˆ†äº«â€å›¾æ ‡ -> â€œæ·»åŠ åˆ°ä¸»å±å¹•â€";
      banner.style.display = 'flex';
    }
  }

  // é¡µé¢åŠ è½½åç«‹å³æ£€æŸ¥æ˜¾ç¤ºçŠ¶æ€
  window.addEventListener('DOMContentLoaded', () => {
    applyIosPrompt();
    // å®‰å“/PC å³ä½¿æ²¡æœ‰æ•è·åˆ°äº‹ä»¶ä¹Ÿå…ˆè¡Œæ˜¾ç¤ºï¼Œé€šè¿‡ triggerInstall å¤„ç†ä¸åŒæƒ…å†µ
    if (!isIos() && !isStandalone()) {
      banner.style.display = 'flex';
    }
  });

  window.addEventListener('appinstalled', () => {
    banner.style.display = 'none';
    deferredPrompt = null;
  });

  function triggerInstall() {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') banner.style.display = 'none';
        deferredPrompt = null;
      });
    } else {
      if (isIos()) {
        alert("ğŸ iOS æç¤ºï¼š\nè¯·ç‚¹å‡» Safari æµè§ˆå™¨åº•éƒ¨çš„â€˜åˆ†äº«â€™æŒ‰é’®ï¼Œæ‰¾åˆ°â€˜æ·»åŠ åˆ°ä¸»å±å¹•â€™å³å¯ã€‚");
      } else {
        alert("ğŸ¤– æç¤ºï¼š\nè¯·ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„èœå•ï¼ˆä¸‰ä¸ªç‚¹ï¼‰ï¼Œé€‰æ‹©â€˜å®‰è£…åº”ç”¨â€™æˆ–â€˜æ·»åŠ åˆ°ä¸»å±å¹•â€™ã€‚");
      }
    }
  }

  function isIos() {
    return /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
  }

  function isStandalone() {
    return (window.navigator.standalone) || (window.matchMedia('(display-mode: standalone)').matches);
  }

  // --- ä¸šåŠ¡é€»è¾‘ (ä¿æŒä¸åŠ¨) ---
  let missionData = JSON.parse(localStorage.getItem('sales_pwa_v4')) || {
    theme: '', script: '', records: Array(5).fill().map(() => ({ target: '', result: '', date: '' }))
  };

  function init() {
    document.getElementById('theme').value = missionData.theme;
    document.getElementById('script').value = missionData.script;
    renderSlots();
  }

  function renderSlots() {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = missionData.records.map((rec, i) => `
      <div class="slot ${rec.target ? 'filled' : ''}">
        <div style="font-size:0.75rem; color:#a0aec0; margin-bottom:5px;">#${i+1} ${rec.date || 'ç­‰å¾…å‡ºå‡»...'}</div>
        <input type="text" placeholder="å¯¹æ–¹å§“å/å¹³å°" value="${rec.target}" onchange="updateRecord(${i}, 'target', this.value)">
        <textarea placeholder="ç»“æœä¸æ„Ÿæ‚Ÿ..." onchange="updateRecord(${i}, 'result', this.value)">${rec.result}</textarea>
      </div>
    `).join('');
  }

  function updateRecord(i, field, value) {
    missionData.records[i][field] = value;
    if (field === 'target' && value && !missionData.records[i].date) {
      missionData.records[i].date = new Date().toLocaleTimeString();
    }
    saveData(); renderSlots();
  }

  function saveData() {
    missionData.theme = document.getElementById('theme').value;
    missionData.script = document.getElementById('script').value;
    localStorage.setItem('sales_pwa_v4', JSON.stringify(missionData));
  }

  function exportCSV() {
    let csv = "\uFEFFæ—¥æœŸ,ç›®æ ‡,ç»“æœ\n";
    missionData.records.forEach(r => { if(r.target) csv += `"${r.date}","${r.target}","${r.result}"\n`; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æˆ˜æŠ¥_${new Date().toLocaleDateString()}.csv`;
    a.click();
    if(confirm("æˆ˜æŠ¥å·²ä¸‹è½½ï¼Œæ˜¯å¦å¼€å¯æ–°çš„ä¸€å¤©ï¼Ÿ")) {
      localStorage.removeItem('sales_pwa_v4');
      location.reload();
    }
  }

  init();
</script>
</body>
</html>